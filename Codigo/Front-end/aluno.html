<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel do Aluno ‚Äî Minha Grade (Aluno adiciona, sem professor na grade)</title>
<style>
:root{
  --cor-primaria:#495057;
  --fundo:#f4f4f9;
  --azul-bebe:#90C3FF;
  --azul-bebe-sec:#B3D9FF;
  --alerta:#C93D3E;
  --sombra:0 6px 18px rgba(0,0,0,0.08);
}
*{box-sizing:border-box}
body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--fundo);margin:0;color:#222}
header{background:var(--cor-primaria);color:#fff;padding:18px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--sombra)}
header h1{margin:0;font-size:1.2rem}
.header-right{display:flex;align-items:center;gap:12px}
#perfil-click{display:flex;align-items:center;gap:10px;cursor:pointer}
#foto-header{width:44px;height:44px;background:#3949AB;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;overflow:hidden}
#foto-header img{width:100%;height:100%;object-fit:cover;border-radius:50%}
#nome-text{font-weight:700}
#btn-logout{background:#fff;color:var(--cor-primaria);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}

main{max-width:1200px;margin:26px auto;padding:18px}
.card{background:#fff;border-radius:10px;padding:18px;box-shadow:var(--sombra);margin-bottom:20px}
h2{margin:0 0 12px 0;color:var(--cor-primaria);font-size:1.05rem;border-bottom:2px solid #e9ecef;padding-bottom:8px}


.form-group{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
.form-control{flex:1;display:flex;flex-direction:column}
.form-control label{font-weight:700;margin-bottom:6px;color:#444}
select,button,input{padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff}
#btn-adicionar{background:var(--azul-bebe);border:none;color:#fff;font-weight:800;cursor:pointer}


#painel-controle{display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;background:#f1f5f9;margin:12px 0}
.btn-acao{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
#btn-exportar{background:var(--azul-bebe-sec);color:#fff}
#btn-limpar{background:#fff;border:2px solid var(--alerta);color:var(--alerta)}


#legenda-periodos{display:flex;gap:12px;flex-wrap:wrap;padding:12px 0;border-top:2px dashed #eef2f7;border-bottom:2px dashed #eef2f7}
.legenda-item{display:flex;align-items:center;gap:8px;color:#495057;font-weight:600}
.legenda-cor{width:12px;height:12px;border-radius:50%;display:inline-block;border:1px solid rgba(0,0,0,0.06)}
.periodo-1{background:#38a169}.periodo-2{background:#d69e2e}.periodo-3{background:#4299e1}.periodo-4{background:#805ad5}.periodo-5{background:#e53e3e}


#calendario-grade{background:#fff;border-radius:10px;overflow:hidden;box-shadow:var(--sombra)}
.calendario-header{display:grid;grid-template-columns:60px repeat(5,1fr);border-bottom:2px solid #ddd;background:#eef2ff;font-weight:700}
.calendario-header>div{text-align:center;padding:12px 5px;border-right:1px solid #dee2e6}
.calendario-header>div:last-child{border-right:none}
.calendario-body{display:grid;grid-template-columns:60px repeat(5,1fr);grid-template-rows:repeat(16,40px);position:relative}
.time-label{grid-column:1;padding-right:8px;text-align:right;color:#6c757d;padding-top:6px;border-right:1px solid #eee;pointer-events:none;background:#fafafa}
.grade-line{grid-column:2 / span 5;border-bottom:1px dashed #e9ecef;pointer-events:none;height:40px;}

#grade-container{position:absolute;left:60px;top:0;right:0;bottom:0}


.disciplina-bloco{position:absolute;padding:6px 8px;border-radius:8px;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.12);cursor:default;font-weight:700;overflow:hidden;transition:transform .12s}
.disciplina-bloco small{display:block;font-weight:600;font-size:.85rem}
.disciplina-bloco .meta{display:block;font-weight:600;font-size:.8rem;color:rgba(255,255,255,0.9)}
.disciplina-bloco:hover{transform:translateY(-4px)}


.disciplina-bloco .remove-btn{
  position:absolute; right:6px; top:6px; width:22px; height:22px; border-radius:50%;
  background:rgba(0,0,0,0.18); color:#fff; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-weight:700; line-height:1; z-index:20;
}
.disciplina-bloco .remove-btn:hover{background:rgba(0,0,0,0.28);}


#modal-perfil{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:9999}
.modal-content{background:#fff;border-radius:12px;padding:20px;width:360px;position:relative;text-align:center}
.modal-content button.close{position:absolute;top:8px;right:10px;border:none;background:none;font-size:20px;cursor:pointer}
#foto-perfil{width:96px;height:96px;border-radius:50%;background:#3949AB;color:#fff;font-size:36px;font-weight:800;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;cursor:pointer;overflow:hidden}
#foto-perfil img{width:100%;height:100%;object-fit:cover;border-radius:50%}
input[type="file"]{display:none}


.aviso-item{background:#E8EAF6;padding:10px;margin-top:10px;border-radius:8px}
footer{text-align:center;padding:10px 0;color:#6c757d;margin-top:12px}

@media (max-width:900px){
  .form-group{flex-direction:column}
  .calendario-header{font-size:14px}
  #grade-container{left:60px;right:8px}

  #calendario-grade{overflow:auto}
}
</style>
</head>
<body>

<header>
  <h1>Painel do Aluno</h1>
  <div class="header-right">
    <div id="perfil-click" title="Abrir perfil">
      <div id="foto-header" aria-hidden="true"></div>
      <div id="nome-text" aria-hidden="true"></div>
    </div>
    <button id="btn-logout">Sair</button>
  </div>
</header>

<main>
  <section id="adicionar-disciplinas" class="card">
    <h2>Adicionar Disciplinas</h2>
    <form id="form-adicao">
      <div class="form-group" style="margin-top:8px">
        <div class="form-control" style="flex:0 1 150px">
          <label for="filtro-periodo">Filtrar por Per√≠odo:</label>
          <select id="filtro-periodo"><option value="0">Todos os Per√≠odos</option></select>
        </div>

        <div class="form-control">
          <label for="disc-id">Disciplina:</label>
          <select id="disc-id" required><option value="">Selecione a Disciplina</option></select>
        </div>

        <div class="form-control">
          <label for="bloco-turma-id">Hor√°rio / Turma:</label>
          <select id="bloco-turma-id" required disabled><option value="">Selecione a Disciplina primeiro</option></select>
        </div>

        <div class="form-control" style="flex:0 1 140px">
          <label style="opacity:0">Adicionar</label>
          <button id="btn-adicionar" class="btn" type="submit">Adicionar √† Grade</button>
        </div>
      </div>
    </form>

    <div id="painel-controle" style="margin-top:14px">
      <button id="btn-exportar" class="btn-acao">üìÑ Exportar Grade (Imprimir/PDF)</button>
      <button id="btn-limpar" class="btn-acao">üóëÔ∏è Limpar TODAS as Disciplinas</button>
    </div>

    <p style="margin-top:10px;color:#6c757d">Dica: Use o ‚Äú√ó‚Äù dentro de cada bloco para remov√™-lo individualmente.</p>
  </section>

  <section class="card">
    <h2>Grade de Hor√°rios Atual</h2>

    <div id="legenda-periodos">
      <div class="legenda-item"><span class="legenda-cor periodo-1"></span> 1¬∫ Per√≠odo</div>
      <div class="legenda-item"><span class="legenda-cor periodo-2"></span> 2¬∫ Per√≠odo</div>
      <div class="legenda-item"><span class="legenda-cor periodo-3"></span> 3¬∫ Per√≠odo</div>
      <div class="legenda-item"><span class="legenda-cor periodo-4"></span> 4¬∫ Per√≠odo</div>
      <div class="legenda-item"><span class="legenda-cor periodo-5"></span> 5¬∫ Per√≠odo</div>
    </div>

    <div id="calendario-grade">
      <div class="calendario-header">
        <div>Hora</div>
        <div data-dia="Seg">Segunda</div>
        <div data-dia="Ter">Ter√ßa</div>
        <div data-dia="Qua">Quarta</div>
        <div data-dia="Qui">Quinta</div>
        <div data-dia="Sex">Sexta</div>
      </div>

      <div class="calendario-body" id="cal-body">
     
        <div id="grade-container"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Avisos</h2>
    <div id="lista-avisos"></div>
  </section>
</main>


<div id="modal-perfil">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="perfil-nome">
    <button class="close" id="fechar-perfil" aria-label="Fechar">&times;</button>
    <div id="foto-perfil" title="Clique para trocar a foto"></div>
    <input type="file" id="input-foto" accept="image/*">
    <div style="margin-top:10px;font-weight:700" id="perfil-nome"></div>
    <div style="color:#666;margin-top:6px" id="perfil-numero"></div>
    <div style="margin-top:12px">
      <button id="remover-foto" style="background:#e53e3e;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Remover foto</button>
    </div>
  </div>
</div>

<footer>&copy; 2025 ‚Äî Sistema de Hor√°rios</footer>

<script>
const API_URL = "https://localhost:7072/api"; 

const HORA_INICIO_GRADE = 7;
const ALTURA_HORA_PIXELS = 40;
const mapDiaColuna = { 'Seg': 2, 'Ter': 3, 'Qua': 4, 'Qui': 5, 'Sex': 6 };

let catalogoAlocacoes = [];
let alocacoesPersonalizadas = [];
const STORAGE_KEY = 'minhaGradeAlunoBD';

const DOM = {};

document.addEventListener('DOMContentLoaded', async () => {
    verificarLogin();
    initDOM();
    renderizarEstruturaGrade();
    
    await carregarDadosAPI();
    carregarAvisosAPI();
    
    const salvas = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    alocacoesPersonalizadas = salvas;
    renderizarGrade();
});

function initDOM(){
  DOM.form = document.getElementById('form-adicao');
  DOM.filtroPeriodo = document.getElementById('filtro-periodo');
  DOM.discId = document.getElementById('disc-id');
  DOM.blocoTurmaId = document.getElementById('bloco-turma-id');
  DOM.gradeContainer = document.getElementById('grade-container');
  DOM.btnLimpar = document.getElementById('btn-limpar');
  DOM.btnExportar = document.getElementById('btn-exportar');
  DOM.listaAvisos = document.getElementById('lista-avisos');

  if(DOM.filtroPeriodo) DOM.filtroPeriodo.addEventListener('change', popularDisciplinas);
  if(DOM.discId) DOM.discId.addEventListener('change', popularTurmas);
  if(DOM.form) DOM.form.addEventListener('submit', handleFormSubmit);
  if(DOM.btnLimpar) DOM.btnLimpar.addEventListener('click', limparGradeCompleta);
  if(DOM.btnExportar) DOM.btnExportar.addEventListener('click', exportarGrade);
}

async function carregarDadosAPI() {
    try {
        const res = await fetch(`${API_URL}/alocacoes`);
        if(!res.ok) throw new Error("Erro API");
        catalogoAlocacoes = await res.json();
        
        popularFiltroPeriodo();
        popularDisciplinas();
    } catch(e) {
        console.error(e);
        alert("Erro ao carregar dados do sistema. Verifique se a API est√° rodando.");
    }
}

function popularFiltroPeriodo(){
    const periodos = [...new Set(catalogoAlocacoes.map(d => d.periodo))].sort((a,b)=>a-b);
    
    DOM.filtroPeriodo.innerHTML = '<option value="0">Todos os Per√≠odos</option>';
    periodos.forEach(p => {
        if(p) {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = `${p}¬∫ Per√≠odo`;
            DOM.filtroPeriodo.appendChild(opt);
        }
    });
}

function popularDisciplinas(){
    DOM.discId.innerHTML = '<option value="">Selecione a Disciplina</option>';
    DOM.blocoTurmaId.innerHTML = '<option value="">Selecione a Disciplina primeiro</option>';
    DOM.blocoTurmaId.disabled = true;

    const periodoFiltro = Number(DOM.filtroPeriodo.value);
    
    const mapDisc = new Map();
    catalogoAlocacoes.forEach(a => {
        if(periodoFiltro === 0 || a.periodo === periodoFiltro) {
            if(!mapDisc.has(a.id_disciplina)) {
                mapDisc.set(a.id_disciplina, { nome: a.disciplina, periodo: a.periodo });
            }
        }
    });

    const listaOrdenada = Array.from(mapDisc.entries()).sort((a,b) => a[1].periodo - b[1].periodo);

    let currentPeriodo = 0;
    let optgroup = null;

    listaOrdenada.forEach(([id, dados]) => {
        if(dados.periodo !== currentPeriodo) {
            currentPeriodo = dados.periodo;
            optgroup = document.createElement('optgroup');
            optgroup.label = `${dados.periodo}¬∫ Per√≠odo`;
            DOM.discId.appendChild(optgroup);
        }
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = dados.nome;
        optgroup.appendChild(opt);
    });
}

function popularTurmas(){
    const discId = Number(DOM.discId.value);
    DOM.blocoTurmaId.innerHTML = '<option value="">Selecione o Hor√°rio</option>';
    DOM.blocoTurmaId.disabled = true;

    if(!discId) return;

    const turmas = catalogoAlocacoes.filter(a => a.id_disciplina === discId);

    if(turmas.length === 0){
        DOM.blocoTurmaId.innerHTML = '<option>Sem turmas cadastradas</option>';
        return;
    }

    turmas.forEach(t => {
        const horaIni = t.hora_inicio.substring(0,5);
        const horaFim = t.hora_fim.substring(0,5);
        const opt = document.createElement('option');
        opt.value = t.id_alocacao;
        opt.textContent = `${t.dia_semana || 'ND'} | ${horaIni}-${horaFim} | Prof. ${t.professor} | Sala ${t.sala}`;
        DOM.blocoTurmaId.appendChild(opt);
    });
    DOM.blocoTurmaId.disabled = false;
}

function handleFormSubmit(e){
    e.preventDefault();
    const idAlocacao = Number(DOM.blocoTurmaId.value);
    if(!idAlocacao) return;

    const aula = catalogoAlocacoes.find(a => a.id_alocacao === idAlocacao);
    if(!aula) return;

    if(alocacoesPersonalizadas.some(a => a.id_alocacao === idAlocacao)) {
        alert("Esta aula j√° est√° na sua grade.");
        return;
    }

    const choque = alocacoesPersonalizadas.find(a => 
        a.dia_semana === aula.dia_semana && 
        a.hora_inicio === aula.hora_inicio
    );
    if(choque) {
        alert(`Choque de hor√°rio com ${choque.disciplina} na ${choque.dia_semana}!`);
        return;
    }

    alocacoesPersonalizadas.push(aula);
    salvarGrade();
    renderizarGrade();
    alert("Adicionado com sucesso!");
}

function horaParaMinutos(h){ 
    if(!h) return 0;
    const [hh,mm] = h.split(':').map(Number); 
    return hh*60+mm; 
}

function calcularPosicaoBloco(inicio, fim){
    const minutosInicio = horaParaMinutos(inicio);
    const minutosFim = horaParaMinutos(fim);
    const minutosGradeInicio = HORA_INICIO_GRADE * 60;
    
    const desloc = minutosInicio - minutosGradeInicio;
    const duracao = minutosFim - minutosInicio;
    
    return { 
        top: (desloc / 60) * ALTURA_HORA_PIXELS, 
        height: (duracao / 60) * ALTURA_HORA_PIXELS 
    };
}

function renderizarBlocos(){
    DOM.gradeContainer.innerHTML = '';
    
    alocacoesPersonalizadas.forEach(aloc => {
        if(!aloc.dia_semana || !mapDiaColuna[aloc.dia_semana]) return;

        const { top, height } = calcularPosicaoBloco(aloc.hora_inicio, aloc.hora_fim);
        
        const bloco = document.createElement('div');
        bloco.className = `disciplina-bloco periodo-${aloc.periodo || 1}`;
        
        const coluna = mapDiaColuna[aloc.dia_semana];
        const diaIndex = coluna - 2;
        const leftPercent = diaIndex * (100/5);
        
        bloco.style.left = `calc(${leftPercent}% + 6px)`;
        bloco.style.top = `${top}px`;
        bloco.style.height = `${Math.max(20, height - 4)}px`;
        bloco.style.width = `calc(${100/5 - 4}%)`;

        bloco.innerHTML = `
            <strong>${aloc.disciplina}</strong>
            <small class="meta">${aloc.sala} ‚Ä¢ Prof. ${aloc.professor.split(' ')[0]}</small>
            <button class="remove-btn" title="Remover">√ó</button>
        `;

        bloco.querySelector('.remove-btn').addEventListener('click', (ev) => {
            ev.stopPropagation();
            if(confirm(`Remover ${aloc.disciplina}?`)) {
                alocacoesPersonalizadas = alocacoesPersonalizadas.filter(a => a.id_alocacao !== aloc.id_alocacao);
                salvarGrade();
                renderizarGrade();
            }
        });

        DOM.gradeContainer.appendChild(bloco);
    });
}

function renderizarEstruturaGrade(){
  const calendarioBody = document.querySelector('.calendario-body');
  Array.from(calendarioBody.children).forEach(child=>{
    if (child.id !== 'grade-container') calendarioBody.removeChild(child);
  });
  
  let rowIndex = 1;
  for(let h = HORA_INICIO_GRADE; h <= 22; h++){
    const timeStr = `${String(h).padStart(2,'0')}:00`;
    const label = document.createElement('div');
    label.className = 'time-label';
    label.textContent = timeStr;
    label.style.gridRow = rowIndex;
    calendarioBody.insertBefore(label, DOM.gradeContainer);
    if (h < 22){
      const line = document.createElement('div');
      line.className = 'grade-line';
      line.style.gridRow = rowIndex + 1;
      calendarioBody.insertBefore(line, DOM.gradeContainer);
    }
    rowIndex++;
  }
}

function renderizarGrade(){
    if(document.querySelectorAll('.time-label').length === 0) renderizarEstruturaGrade();
    renderizarBlocos();
}

async function carregarAvisosAPI() {
    try {
        const res = await fetch(`${API_URL}/avisos`);
        const avisos = await res.json();
        const lista = DOM.listaAvisos;
        
        if (avisos.length === 0){ 
            lista.innerHTML = '<p style="color:gray;font-style:italic">Nenhum aviso dispon√≠vel.</p>'; 
            return; 
        }
        
        lista.innerHTML = avisos.map(a => `
            <div class="aviso-item">
                <strong>${a.autor || 'Coordena√ß√£o'}</strong>: ${a.mensagem}<br>
                <small>${new Date(a.data_publicacao).toLocaleString()}</small>
            </div>
        `).join('');
    } catch(e) { console.error("Erro avisos"); }
}

function salvarGrade(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(alocacoesPersonalizadas)); }

function limparGradeCompleta(){
    if(confirm("Limpar grade?")){
        alocacoesPersonalizadas = [];
        salvarGrade();
        renderizarGrade();
    }
}
function exportarGrade(){ window.print(); }

function verificarLogin(){
    const user = JSON.parse(sessionStorage.getItem('usuarioLogado'));
    if(!user) window.location.href = 'login.html';
    
    document.getElementById('nome-text').textContent = user.nome;
    document.getElementById('perfil-nome').textContent = user.nome;
    document.getElementById('perfil-numero').textContent = user.id || '';
    
    const avatarSalvo = localStorage.getItem('avatar_'+user.login);
    atualizarAvatar(avatarSalvo);
}

function atualizarAvatar(src){
  const header = document.getElementById('foto-header');
  const modalFoto = document.getElementById('foto-perfil');
  const user = JSON.parse(sessionStorage.getItem('usuarioLogado'));
  
  if (src){
    const imgTag = `<img src="${src}" alt="avatar">`;
    header.innerHTML = imgTag;
    modalFoto.innerHTML = imgTag;
  } else {
    const iniciais = user ? user.nome.substring(0,2).toUpperCase() : 'AL';
    header.textContent = iniciais;
    modalFoto.textContent = iniciais;
  }
}

const modal = document.getElementById('modal-perfil');
document.getElementById('perfil-click').addEventListener('click', ()=> modal.style.display = 'flex');
document.getElementById('fechar-perfil').addEventListener('click', ()=> modal.style.display = 'none');
window.addEventListener('click', (ev)=> { if (ev.target === modal) modal.style.display = 'none'; });

const inputFoto = document.getElementById('input-foto');
document.getElementById('foto-perfil').addEventListener('click', ()=> inputFoto.click());
inputFoto.addEventListener('change', e=>{
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result;
            const user = JSON.parse(sessionStorage.getItem('usuarioLogado'));
            localStorage.setItem('avatar_'+user.login, base64);
            atualizarAvatar(base64);
        };
        reader.readAsDataURL(file);
    }
});
document.getElementById('remover-foto').addEventListener('click', ()=>{
    const user = JSON.parse(sessionStorage.getItem('usuarioLogado'));
    localStorage.removeItem('avatar_'+user.login);
    atualizarAvatar(null);
});
document.getElementById('btn-logout').addEventListener('click', ()=>{
    sessionStorage.removeItem('usuarioLogado');
    window.location.href = 'login.html';
});
</script>
</body>
</html>
