<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard do Coordenador</title>
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f4f9; margin:0; padding:0; }
header { background:#495057; color:white; padding:20px; text-align:center; }
header h1 { margin:0; }
main { max-width:1400px; margin:20px auto; padding:0 20px; }
section { background:white; padding:20px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:20px; }
h2 { color:#495057; border-bottom:2px solid #e9ecef; padding-bottom:8px; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:left; }
th { background:#e9ecef; }
input, select, textarea, button { padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
button { cursor:pointer; transition:0.2s; font-weight:bold; }
button:hover { opacity:0.9; }
.btn-excluir { background:#dc3545; color:white; }
.btn-editar { background:#ffc107; color:white; }
.filtros { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
.btn-filtro { padding:10px 18px; color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.95em; }
.ativo { box-shadow:0 0 0 3px rgba(0,0,0,0.2) inset; }
.periodo-1 { background:#38a169; } 
.periodo-2 { background:#d69e2e; } 
.periodo-3 { background:#4299e1; } 
.periodo-4 { background:#805ad5; } 
.periodo-5 { background:#e53e3e; } 
.btn-todos { background:#495057; }
#grade-container { position:relative; min-height:200px; margin-top:10px; border:1px solid #ddd; border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:8px; }
.disciplina-bloco { padding:10px; color:white; border-radius:6px; font-size:0.9em; }
#lista-avisos { margin-top:12px; }
</style>
</head>
<body>
<header><h1>Dashboard do Coordenador</h1></header>
<main>


<section>
    <h2>Professores Cadastrados (<span id="numero-professores">0</span>)</h2>
    <input type="text" id="pesquisa-professor" placeholder="Pesquisar professor...">
    <form id="form-professor">
        <input type="text" id="nome-professor" placeholder="Nome do Professor" required>
        <input type="text" id="login-professor" placeholder="Login" required>
        <input type="text" id="senha-professor" placeholder="Senha" required>
        <button type="submit" style="background:#90C3FF; color:white;">Adicionar Professor</button>
    </form>
    <table id="tabela-professores">
        <thead><tr><th>Nome</th><th>Login</th><th>Senha</th><th>Ação</th></tr></thead>
        <tbody></tbody>
    </table>
</section>


<section>
    <h2>Alunos Cadastrados (<span id="numero-alunos">0</span>)</h2>
    <input type="text" id="pesquisa-aluno" placeholder="Pesquisar aluno...">
    <form id="form-aluno">
        <input type="text" id="nome-aluno" placeholder="Nome do Aluno" required>
        <input type="text" id="login-aluno" placeholder="Login" required>
        <input type="text" id="senha-aluno" placeholder="Senha" required>
        <button type="submit" style="background:#38a169; color:white;">Adicionar Aluno</button>
    </form>
    <table id="tabela-alunos">
        <thead><tr><th>Nome</th><th>Login</th><th>Senha</th><th>Ação</th></tr></thead>
        <tbody></tbody>
    </table>
</section>


<section>
    <h2>Alocar Professores nas Disciplinas</h2>
    <form id="form-alocacao">
        <select id="select-disciplina" required></select>
        <select id="select-professor" required></select>
        <button type="submit" style="background:#4299e1; color:white;">Alocar</button>
    </form>
    <table id="tabela-alocacoes">
        <thead><tr><th>Disciplina</th><th>Professores</th><th>Ação</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<section>
    <h2>Grade de Disciplinas</h2>
    <div class="filtros">
        <button class="btn-filtro btn-todos ativo" data-periodo="todos">Todos</button>
        <button class="btn-filtro periodo-1" data-periodo="1">1º Período</button>
        <button class="btn-filtro periodo-2" data-periodo="2">2º Período</button>
        <button class="btn-filtro periodo-3" data-periodo="3">3º Período</button>
        <button class="btn-filtro periodo-4" data-periodo="4">4º Período</button>
        <button class="btn-filtro periodo-5" data-periodo="5">5º Período</button>
    </div>
    <div id="grade-container"></div>
</section>


<section>
    <h2>Avisos</h2>
    <form id="form-aviso">
        <textarea id="texto-aviso" placeholder="Escreva um aviso..." required style="width:100%;height:60px;padding:8px;border-radius:6px;border:1px solid #ccc;"></textarea>
        <button type="submit" style="background:#38a169;color:white;margin-top:6px;">Adicionar Aviso</button>
    </form>
    <div id="lista-avisos"></div>
</section>

</main>

<script>
    const API_URL = "https://localhost:7072/api";
    let listaAlocacoes = [];

    async function init() {
        await carregarProfessores();
        await carregarAlunos();
        await carregarAuxiliaresAlocacao();
        await carregarAlocacoes();
        await carregarAvisos();
    }

    async function gerarRelatorio(id) {
        const div = document.getElementById('resultado-relatorio');
        div.innerHTML = "Carregando...";
        try {
            const res = await fetch(`${API_URL}/relatorios/${id}`);
            const dados = await res.json();
            
            if(dados.length === 0) {
                div.innerHTML = "Nenhum resultado encontrado.";
                return;
            }

            const colunas = Object.keys(dados[0]);
            let html = '<table style="font-size:14px;"><thead><tr>';
            colunas.forEach(c => html += `<th>${c.toUpperCase()}</th>`);
            html += '</tr></thead><tbody>';
            
            dados.forEach(linha => {
                html += '<tr>';
                colunas.forEach(c => html += `<td>${linha[c]}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table>';
            div.innerHTML = html;

        } catch(e) {
            div.innerHTML = `<span style="color:red">Erro ao executar query: ${e.message}</span>`;
        }
    }

    async function carregarProfessores() {
        const res = await fetch(`${API_URL}/professores`);
        const profs = await res.json();
        const tbody = document.querySelector('#tabela-professores tbody');
        const select = document.getElementById('select-professor');
        tbody.innerHTML = ''; select.innerHTML = '';
        profs.forEach(p => {
            tbody.innerHTML += `<tr><td>${p.nome}</td><td>${p.login || '-'}</td><td>${p.email}</td></tr>`;
            select.innerHTML += `<option value="${p.id_professor}">${p.nome}</option>`;
        });
    }
    document.getElementById('form-professor').addEventListener('submit', async (e) => {
        e.preventDefault();
        const dados = { nome: document.getElementById('nome-professor').value, login: document.getElementById('login-professor').value, senha: document.getElementById('senha-professor').value };
        await fetch(`${API_URL}/professores`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(dados) });
        alert("Professor cadastrado!"); carregarProfessores(); e.target.reset();
    });

    async function carregarAlunos() {
        const res = await fetch(`${API_URL}/alunos`);
        const alunos = await res.json();
        const tbody = document.querySelector('#tabela-alunos tbody');
        tbody.innerHTML = '';
        alunos.forEach(a => tbody.innerHTML += `<tr><td>${a.nome}</td><td>${a.email}</td><td>${a.matricula}</td></tr>`);
    }
    document.getElementById('form-aluno').addEventListener('submit', async (e) => {
        e.preventDefault();
        const dados = { nome: document.getElementById('nome-aluno').value, login: document.getElementById('login-aluno').value };
        const res = await fetch(`${API_URL}/alunos`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(dados) });
        const json = await res.json(); alert("Aluno criado! Matrícula: " + json.matriculaGerada); carregarAlunos(); e.target.reset();
    });

    async function carregarAuxiliaresAlocacao() {
    try {
        const resD = await fetch(`${API_URL}/disciplinas`);
        const discs = await resD.json();
        const selD = document.getElementById('select-disciplina');
        if(selD) {
            selD.innerHTML = '';
            discs.forEach(d => selD.innerHTML += `<option value="${d.id_disciplina}">${d.nome} (P${d.periodo || '?'})</option>`);
        }

        const selS = document.getElementById('select-sala');
        if(selS) {
            const resS = await fetch(`${API_URL}/salas`);
            const salas = await resS.json();
            selS.innerHTML = '';
            salas.forEach(s => selS.innerHTML += `<option value="${s.id_sala}">Sala ${s.numero}</option>`);
        }

        const selT = document.getElementById('select-turno');
        if(selT) {
            const resT = await fetch(`${API_URL}/turnos`);
            const turnos = await resT.json();
            selT.innerHTML = '';
            turnos.forEach(t => selT.innerHTML += `<option value="${t.id_turno}">${t.nome} (${t.hora_inicio}-${t.hora_fim})</option>`);
        }
    } catch(e) { console.error("Erro ao carregar auxiliares", e); }
    }

    async function carregarAlocacoes() {
        const res = await fetch(`${API_URL}/alocacoes`); listaAlocacoes = await res.json();
        const tbody = document.querySelector('#tabela-alocacoes tbody'); tbody.innerHTML = '';
        listaAlocacoes.forEach(a => {
            tbody.innerHTML += `<tr><td>${a.disciplina}</td><td>${a.professor}</td><td>${a.sala}</td><td>${a.turno_nome}</td><td><button class="btn-excluir" onclick="removerAlocacao(${a.id_alocacao})">Remover</button></td></tr>`;
        });
        filtrarGrade(0);
    }
    async function removerAlocacao(id) {
        if(confirm("Remover?")) { await fetch(`${API_URL}/alocacoes/${id}`, { method:'DELETE' }); carregarAlocacoes(); }
    }
    function filtrarGrade(periodo) {
        const container = document.getElementById('grade-container'); container.innerHTML = '';
        const filtradas = periodo === 0 ? listaAlocacoes : listaAlocacoes.filter(a => a.periodo === periodo);
        if(filtradas.length === 0) container.innerHTML = '<p style="color:#666;width:100%">Nenhuma disciplina encontrada.</p>';
        filtradas.forEach(a => {
            const div = document.createElement('div'); div.className = `disciplina-bloco periodo-${a.periodo || 1}`;
            const cores = ['#38a169', '#d69e2e', '#4299e1', '#805ad5', '#e53e3e'];
            div.style.background = cores[(a.periodo - 1)] || '#333';
            div.innerHTML = `<strong>${a.disciplina}</strong><br>Prof. ${a.professor}<br>${a.sala} | ${a.turno_nome}`;
            container.appendChild(div);
        });
    }

    async function carregarAvisos() {
        const res = await fetch(`${API_URL}/avisos`); const avisos = await res.json();
        const lista = document.getElementById('lista-avisos');
        if(avisos.length === 0) lista.innerHTML = '<p style="color:gray;">Sem avisos.</p>';
        else lista.innerHTML = avisos.map(a => `<div style="background:#fff; padding:10px; margin-bottom:8px; border-left:4px solid #38a169; border-radius:4px;"><strong>${a.autor || 'Coordenação'}</strong>: ${a.mensagem} <br><small style="color:#888">${new Date(a.data_publicacao).toLocaleString()}</small></div>`).join('');
    }
    document.getElementById('form-aviso').addEventListener('submit', async (e) => {
        e.preventDefault(); const texto = document.getElementById('texto-aviso').value;
        await fetch(`${API_URL}/avisos`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ texto: texto, autor: 'Coordenador' }) });
        document.getElementById('texto-aviso').value = ''; carregarAvisos();
    });

    init();
</script>
</body>
</html>
